---
# tasks file for zabbix-server
- name: Install the zabbix repo rpm from an official repo
  ansible.builtin.dnf:
    name: 'https://repo.zabbix.com/zabbix/6.2/rhel/8/x86_64/zabbix-release-6.2-3.el8.noarch.rpm'
    disable_gpg_check: true
    state: present

- name: switch php to 7.4
  ansible.builtin.shell: dnf module switch-to php:7.4 -y

- name: Installing packages
  ansible.builtin.dnf:
    name: ['zabbix-server-pgsql', 'zabbix-web-pgsql', 'zabbix-nginx-conf', 'zabbix-sql-scripts', 'zabbix-selinux-policy']
    state: present

- name: creating pgsql Zabbix user
  ansible.builtin.shell: su - postgres -c 'psql --command "CREATE USER zabbix WITH PASSWORD '\'123456789\'';"'

- name: creating pgsql Zabbix DB
  ansible.builtin.shell: su - postgres -c 'psql --command "CREATE DATABASE zabbix OWNER zabbix;"'

- name: Importing SQL scripts
  ansible.builtin.shell: zcat /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz | sudo -u zabbix psql zabbix 