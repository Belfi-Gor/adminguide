---
# tasks file for postgresql-14
- name: Install the postgresql-14 repo rpm from an official repo
  ansible.builtin.dnf:
    name: 'https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm'
    disable_gpg_check: true
    state: present

- name: Disable the built-in PostgreSQL module
  ansible.builtin.shell: dnf -qy module disable postgresql

- name: Installing Postgresql packages
  ansible.builtin.dnf:
    name: ['postgresql14-server']
    state: present

- name: Install latest pip
  ansible.builtin.pip:
    name: pip
    state: latest

- name: Install psycopg2-binary with pip
  ansible.builtin.pip:
    name: psycopg2-binary
    state: latest   

- name: Postgresqsl-14 initdb
  ansible.builtin.shell: /usr/pgsql-14/bin/postgresql-14-setup initdb

- name: Disable the built-in PostgreSQL module
  ansible.builtin.shell: cat /usr/share/zabbix-sql-scripts/postgresql/proxy.sql | sudo -u zabbix psql zabbix_proxy

  - name: Configure Postgresql DBPassword
  ansible.builtin.lineinfile:
    path: /etc/zabbix/zabbix_server.conf
    regexp: '# DBPassword='
    line: 'DBPassword=123456789'

- name: Postgresql start & enable
  ansible.builtin.systemd:
    name: postgresql-14
    state: started
    enabled: yes