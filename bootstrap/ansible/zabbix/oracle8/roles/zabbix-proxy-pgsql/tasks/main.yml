---
# tasks file for zabbix-proxy-pgsql
- name: Install the zabbix repo rpm from an official repo
  ansible.builtin.dnf:
    name: 'https://repo.zabbix.com/zabbix/6.2/rhel/8/x86_64/zabbix-release-6.2-3.el8.noarch.rpm'
    disable_gpg_check: true
    state: present

- name: Installing packages
  ansible.builtin.dnf:
    name: ['zabbix-proxy-pgsql', 'zabbix-sql-scripts', 'zabbix-selinux-policy']
    state: present

- name: Create postgresql zabbix user
  become: true
  become_user: postgres
  community.postgresql.postgresql_user:
    name: zabbix
    password: '123456789'

- name: Create postgresql zabbix_proxy db
  become: true
  become_user: postgres
  community.postgresql.postgresql_db:
    name: zabbix_proxy

- name: GRANT ALL PRIVILEGES ON DATABASE zabbix_proxy TO zabbix
  become: true
  become_user: postgres
  community.postgresql.postgresql_privs:
    db: postgres
    privs: ALL
    type: database
    obj: zabbix_proxy
    role: zabbix

- name: Disable the built-in PostgreSQL module
  ansible.builtin.shell: cat /usr/share/zabbix-sql-scripts/postgresql/proxy.sql | sudo -u zabbix psql zabbix_proxy

- name: Configure Postgresql DBPassword
  ansible.builtin.lineinfile:
    path: /etc/zabbix/zabbix_server.conf
    regexp: '# DBPassword='
    line: 'DBPassword=123456789'

- name: Zabbix Prozy start & enable
  ansible.builtin.systemd:
    name: postgresql-14
    state: started
    enabled: yes